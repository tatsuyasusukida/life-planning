# ライフプランニングシミュレーション API設計書

## 概要

ユーザーが自身の生年月日と開始・終了年を指定して、シンプルなライフプランシミュレーションを実行するためのAPIエンドポイントです。

## エンドポイント仕様

### POST /api/v1/life-planning/simulation

#### リクエスト

**Content-Type:** `application/json`

```json
{
  "生年月日": "1990-01-01",
  "開始年": 2020,
  "終了年": 2025,
  "年度別給与情報": [
    {
      "年度": 2024,
      "収入金額": 5000000
    },
    {
      "年度": 2025,
      "収入金額": 6000000
    }
  ],
  "年度別社会保険情報": [
    {
      "年度": 2024,
      "健康保険料率": 0.0981,
      "介護保険料率": 0.0164,
      "厚生年金保険料率": 0.183
    },
    {
      "年度": 2025,
      "健康保険料率": 0.0981,
      "介護保険料率": 0.0164,
      "厚生年金保険料率": 0.183
    }
  ]
}
```

##### パラメータ

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| 生年月日 | string | ✓ | 生年月日（ISO 8601形式: YYYY-MM-DD） |
| 開始年 | number | ✓ | シミュレーション開始年（西暦） |
| 終了年 | number | ✓ | シミュレーション終了年（西暦） |
| 年度別給与情報 | array | ✓ | 年度ごとの給与情報の配列（省略された年度は前年度と同額として自動補完） |
| 年度別給与情報[].年度 | number | ✓ | 対象年度（西暦） |
| 年度別給与情報[].収入金額 | number | ✓ | その年度の給与収入金額（円） |
| 年度別社会保険情報 | array | | 年度ごとの社会保険料率情報の配列（省略された年度は前年度と同じ料率で自動補完） |
| 年度別社会保険情報[].年度 | number | ✓ | 対象年度（西暦） |
| 年度別社会保険情報[].健康保険料率 | number | ✓ | 健康保険料率（0～1の範囲、例：0.0981） |
| 年度別社会保険情報[].介護保険料率 | number | ✓ | 介護保険料率（0～1の範囲、例：0.0164） |
| 年度別社会保険情報[].厚生年金保険料率 | number | ✓ | 厚生年金保険料率（0～1の範囲、例：0.183） |

#### レスポンス

##### 成功時（200 OK）

```json
{
  "年度一覧": [
    {
      "西暦年": 2020,
      "年齢": 30,
      "収入金額": 0,
      "給与所得控除額": 0,
      "給与所得控除後の金額": 0,
      "標準報酬月額等級": 1,
      "標準報酬月額": 58000,
      "健康保険料月額": 0,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 0,
      "社会保険料月額": 0,
      "社会保険料年額": 0
    },
    {
      "西暦年": 2021,
      "年齢": 31,
      "収入金額": 0,
      "給与所得控除額": 0,
      "給与所得控除後の金額": 0,
      "標準報酬月額等級": 1,
      "標準報酬月額": 58000,
      "健康保険料月額": 0,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 0,
      "社会保険料月額": 0,
      "社会保険料年額": 0
    },
    {
      "西暦年": 2022,
      "年齢": 32,
      "収入金額": 0,
      "給与所得控除額": 0,
      "給与所得控除後の金額": 0,
      "標準報酬月額等級": 1,
      "標準報酬月額": 58000,
      "健康保険料月額": 0,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 0,
      "社会保険料月額": 0,
      "社会保険料年額": 0
    },
    {
      "西暦年": 2023,
      "年齢": 33,
      "収入金額": 0,
      "給与所得控除額": 0,
      "給与所得控除後の金額": 0,
      "標準報酬月額等級": 1,
      "標準報酬月額": 58000,
      "健康保険料月額": 0,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 0,
      "社会保険料月額": 0,
      "社会保険料年額": 0
    },
    {
      "西暦年": 2024,
      "年齢": 34,
      "収入金額": 5000000,
      "給与所得控除額": 1440000,
      "給与所得控除後の金額": 3560000,
      "標準報酬月額等級": 27,
      "標準報酬月額": 410000,
      "健康保険料月額": 20110,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 37515,
      "社会保険料月額": 57625,
      "社会保険料年額": 691500
    },
    {
      "西暦年": 2025,
      "年齢": 35,
      "収入金額": 6000000,
      "給与所得控除額": 1640000,
      "給与所得控除後の金額": 4360000,
      "標準報酬月額等級": 30,
      "標準報酬月額": 500000,
      "健康保険料月額": 24525,
      "介護保険料月額": 0,
      "厚生年金保険料月額": 45750,
      "社会保険料月額": 70275,
      "社会保険料年額": 843300
    }
  ]
}
```

##### エラー時（400 Bad Request）

```json
{
  "エラー": "エラーメッセージ"
}
```

## エラーケース

| エラーメッセージ | 発生条件 |
|---|---|
| "必須パラメータが不足しています: [パラメータ名]" | 必須パラメータが不足している |
| "[パラメータ名]の日付形式が正しくありません。YYYY-MM-DD形式で入力してください" | 生年月日の形式が不正 |
| "[パラメータ名]の型が正しくありません。[期待する型]型である必要がありますが、[実際の型]型が入力されました" | パラメータの型が不正 |
| "開始年は終了年以下である必要があります" | 開始年が終了年より大きい |
| "年齢が上限の150歳を超えています" | 終了年時点で150歳を超える |
| "JSONフォーマットが正しくありません" | リクエストボディのJSONが不正 |

## 実装詳細

### 年齢計算ロジック

年齢は各年の1月1日時点での満年齢として計算されます：

```
1月1日時点での満年齢 = 対象年 - 生年 - (1月1日 < その年の誕生日 ? 1 : 0)
```

この実装では、各年の1月1日時点で誕生日を迎えているかどうかを判定し、迎えていない場合は年齢から1を引きます。

### バリデーション

1. **Zodスキーマバリデーション**: リクエストボディの型、必須パラメータ、形式を自動検証
2. **年の範囲チェック**: 開始年 ≤ 終了年であることを確認
3. **年齢妥当性チェック**: 終了年時点で150歳を超えないことを確認
4. **JSONフォーマットチェック**: リクエストボディが有効なJSONかチェック

## 使用例

### 基本的な使用例

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2020,
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2020,
        "収入金額": 4500000
      },
      {
        "年度": 2021,
        "収入金額": 4800000
      },
      {
        "年度": 2022,
        "収入金額": 5000000
      },
      {
        "年度": 2023,
        "収入金額": 5200000
      },
      {
        "年度": 2024,
        "収入金額": 5400000
      },
      {
        "年度": 2025,
        "収入金額": 6000000
      }
    ],
    "年度別社会保険情報": [
      {
        "年度": 2020,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2021,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2022,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2023,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2024,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2025,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      }
    ]
  }'
```

### 省略機能を使用した例

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2020,
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2020,
        "収入金額": 5000000
      },
      {
        "年度": 2023,
        "収入金額": 5500000
      }
    ],
    "年度別社会保険情報": [
      {
        "年度": 2020,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      },
      {
        "年度": 2024,
        "健康保険料率": 0.0990,
        "介護保険料率": 0.0170,
        "厚生年金保険料率": 0.183
      }
    ]
  }'
```

上記の例では：
- **給与情報**: 2021年と2022年は2020年と同額（5,000,000円）、2024年と2025年は2023年と同額（5,500,000円）として自動補完
- **社会保険情報**: 2021年、2022年、2023年は2020年と同じ料率、2025年は2024年と同じ料率として自動補完

### 単一年のシミュレーション

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1985-06-15",
    "開始年": 2024,
    "終了年": 2024,
    "年度別給与情報": [
      {
        "年度": 2024,
        "収入金額": 6000000
      }
    ],
    "年度別社会保険情報": [
      {
        "年度": 2024,
        "健康保険料率": 0.0981,
        "介護保険料率": 0.0164,
        "厚生年金保険料率": 0.183
      }
    ]
  }'
```

### 失敗ケースの例

#### 必須パラメータ不足

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2024
  }'
```

**レスポンス:**
```json
{
  "エラー": "必須パラメータが不足しています: 終了年"
}
```

#### 年度別給与情報不足

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2024,
    "終了年": 2025
  }'
```

**レスポンス:**
```json
{
  "エラー": "必須パラメータが不足しています: 年度別給与情報"
}
```

#### 不正な日付フォーマット

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990/01/01",
    "開始年": 2024,
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2024,
        "収入金額": 5000000
      },
      {
        "年度": 2025,
        "収入金額": 6000000
      }
    ]
  }'
```

**レスポンス:**
```json
{
  "エラー": "生年月日の日付形式が正しくありません。YYYY-MM-DD形式で入力してください"
}
```

#### 開始年が終了年より大きい

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2025,
    "終了年": 2024,
    "年度別給与情報": [
      {
        "年度": 2024,
        "収入金額": 5000000
      }
    ]
  }'
```

**レスポンス:**
```json
{
  "エラー": "開始年は終了年以下である必要があります"
}
```

#### 不正な型

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": "invalid",
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2025,
        "収入金額": 5000000
      }
    ]
  }'
```

**レスポンス:**
```json
{
  "エラー": "開始年の型が正しくありません。number型である必要がありますが、string型が入力されました"
}
```

#### 年齢上限超過

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1850-01-01",
    "開始年": 2024,
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2024,
        "収入金額": 5000000
      },
      {
        "年度": 2025,
        "収入金額": 6000000
      }
    ]
  }'
```

**レスポンス:**
```json
{
  "エラー": "年齢が上限の150歳を超えています"
}
```

#### 不正なJSONフォーマット

```bash
curl -X POST http://localhost:8787/api/v1/life-planning/simulation \
  -H "Content-Type: application/json" \
  -d '{
    "生年月日": "1990-01-01",
    "開始年": 2024,
    "終了年": 2025,
    "年度別給与情報": [
      {
        "年度": 2024,
        "収入金額": 5000000
      },
      {
        "年度": 2025,
        "収入金額": 6000000
      }
    ],
  }'
```

**レスポンス:**
```json
{
  "エラー": "JSONフォーマットが正しくありません"
}
```

## 給与所得控除の計算

年度別給与情報が提供された場合、国税庁の給与所得控除額に基づいて自動計算されます（令和2年分以降の税制）：

| 給与等の収入金額 | 給与所得控除額 |
|---|---|
| 162万5千円以下 | 55万円 |
| 162万5千円超 180万円以下 | 収入金額×40％－10万円 |
| 180万円超 360万円以下 | 収入金額×30％＋8万円 |
| 360万円超 660万円以下 | 収入金額×20％＋44万円 |
| 660万円超 850万円以下 | 収入金額×10％＋110万円 |
| 850万円超 | 195万円（上限） |

**給与所得控除後の金額** = 収入金額 - 給与所得控除額

**重要:** 給与所得控除額は収入金額を超えることはありません。収入金額が少ない場合は、給与所得控除額は収入金額と同額になります。

### 年度別給与情報の省略機能

年度別給与情報では、前年度と同じ収入金額の場合は省略することができます。省略された年度は、自動的に前年度と同じ収入金額として補完されます。

**補完ルール:**
- 省略された年度は、その年度より前で最も近い年度の収入金額を使用
- 開始年より前に給与情報がない場合は、その年度の収入金額は0になります

**例:**
```json
{
  "年度別給与情報": [
    { "年度": 2020, "収入金額": 5000000 },
    { "年度": 2022, "収入金額": 5500000 }
  ]
}
```
上記の場合、2021年は2020年と同額（5,000,000円）、2023年以降は2022年と同額（5,500,000円）として自動補完されます。

### レスポンス項目説明

| 項目名 | 型 | 説明 |
|---|---|---|
| 西暦年 | number | 対象年度 |
| 年齢 | number | その年の1月1日時点での満年齢 |
| 収入金額 | number | その年度の給与収入金額（給与情報がない場合は0） |
| 給与所得控除額 | number | 国税庁ルールに基づく給与所得控除額 |
| 給与所得控除後の金額 | number | 収入金額から給与所得控除額を差し引いた金額 |
| 標準報酬月額等級 | number | 健康保険の標準報酬月額等級（1～50） |
| 標準報酬月額 | number | 健康保険の標準報酬月額（円） |
| 健康保険料 | number | 健康保険料（従業員負担分、円） |
| 介護保険料 | number | 介護保険料（従業員負担分、円） |
| 厚生年金保険料 | number | 厚生年金保険料（従業員負担分、円） |
| 社会保険料 | number | 社会保険料合計（健康保険料+介護保険料+厚生年金保険料、円） |

## 社会保険料の計算

### 標準報酬月額の計算

社会保険料は標準報酬月額に基づいて計算されます。ただし、健康保険と厚生年金保険では異なる等級表を使用します：

#### 健康保険（等級1～50）
- 月額給与から健康保険の標準報酬月額等級表に基づいて計算
- 最低額：58,000円（等級1）
- 最高額：1,390,000円（等級50）

#### 厚生年金保険（等級4～35のみ）
- 月額給与から厚生年金保険の標準報酬月額等級表に基づいて計算
- 報酬月額93,000円未満：標準報酬月額88,000円（等級4）
- 報酬月額635,000円以上：標準報酬月額650,000円（等級35）

### 保険料の計算式

各保険料は以下の式で計算されます（従業員負担分のみ）：

- **健康保険料** = 健康保険の標準報酬月額 × 健康保険料率 ÷ 2（端数切り捨て）
- **介護保険料** = 健康保険の標準報酬月額 × 介護保険料率 ÷ 2（端数切り捨て）※40歳以上の場合のみ
- **厚生年金保険料** = 厚生年金保険の標準報酬月額 × 厚生年金保険料率 ÷ 2（端数切り捨て）
- **社会保険料合計** = 健康保険料 + 介護保険料 + 厚生年金保険料

**重要**: 介護保険料は40歳以上の被保険者に対してのみ徴収されます。40歳未満の場合は、介護保険料率が設定されていても介護保険料は0円となります。

### 社会保険情報の省略機能

社会保険情報も給与情報と同様に省略可能です：

- 省略された年度は、その年度より前で最も近い年度の保険料率を使用
- 開始年より前に保険料率情報がない場合は、保険料率0（保険料0円）として計算

### 2024年度標準的な保険料率

参考として、2024年度の全国健康保険協会管掌健康保険の標準的な料率：

- **健康保険料率**: 9.81%（0.0981）
- **介護保険料率**: 1.64%（0.0164）
- **厚生年金保険料率**: 18.3%（0.183）

## 将来の拡張可能性

- 誕生日を考慮した精密な年齢計算
- 所得税・住民税の計算
- ライフイベント（結婚、出産、退職など）の考慮
- 資産運用シミュレーション
- グラフ表示用データの生成
- 都道府県別健康保険料率への対応
- 企業型年金制度への対応